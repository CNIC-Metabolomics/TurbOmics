"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[738],{14565:function(e,t,s){var n=s(26314);t.Z=void 0;var o=n(s(80984)),r=s(57437);t.Z=(0,o.default)((0,r.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle")},25988:function(e,t,s){var n=s(26314);t.Z=void 0;var o=n(s(80984)),r=s(57437);t.Z=(0,o.default)((0,r.jsx)("path",{d:"m6 2 .01 6L10 12l-3.99 4.01L6 22h12v-6l-4-4 4-3.99V2zm10 14.5V20H8v-3.5l4-4z"}),"HourglassTop")},11738:function(e,t,s){s.r(t);var n=s(57437),o=s(2265),r=s(81797),a=s(96350),i=s(29818),l=s(39227),c=s(18687),u=s(85269),d=s(98075),p=s(78063),g=s(86836),h=s(90250),m=s(38939),x=s(54986),f=s(14565),y=s(25988);let v="https://ceumass.eps.uspceu.es/mediator/api/v3/batch";function ModeRow(e){let{label:t,done:s,total:o,finished:r}=e;return(0,n.jsxs)(c.Z,{variant:"outlined",sx:{px:1.5,py:1,borderRadius:2,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,n.jsxs)(l.Z,{children:[(0,n.jsx)(u.Z,{variant:"body2",fontWeight:500,children:t}),(0,n.jsxs)(u.Z,{variant:"caption",color:"text.secondary",children:[s," / ",o," batches"]})]}),r?(0,n.jsx)(g.Z,{icon:(0,n.jsx)(f.Z,{}),label:"Done",size:"small",color:"success",variant:"outlined"}):(0,n.jsx)(g.Z,{icon:(0,n.jsx)(y.Z,{}),label:"Processing",size:"small",color:"warning",variant:"outlined"})]})}function TPRow(e){let{status:t}=e;return(0,n.jsxs)(c.Z,{variant:"outlined",sx:{px:1.5,py:1,borderRadius:2,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,n.jsx)(u.Z,{variant:"body2",fontWeight:500,children:"TurboPutative"}),"ok"===t?(0,n.jsx)(g.Z,{icon:(0,n.jsx)(f.Z,{}),label:"Done",size:"small",color:"success",variant:"outlined"}):"running"===t?(0,n.jsx)(g.Z,{icon:(0,n.jsx)(y.Z,{}),label:"Processing",size:"small",color:"warning",variant:"outlined"}):"error"===t?(0,n.jsx)(g.Z,{label:"Error",size:"small",color:"error",variant:"outlined"}):(0,n.jsx)(g.Z,{label:"Waiting",size:"small",variant:"outlined"})]})}t.default=function(){let{DEV_MODE:e,SERVER_URL:t,API_URL:s}=(0,a.S)(),g=e?"".concat("https://corsproxy.io","/?").concat(encodeURIComponent(v)):v,f=(0,o.useRef)(),y=(0,o.useRef)(!1),j=(0,r.Lq)(),Z=(0,i.mX)(),{CMM:M,TP:P}=(0,i.a0)(),{jobID:b}=(0,r.tc)(),C=(0,r.tc)().idCol.m2i,w=(0,r.tc)().norm.xm.columns,T=(0,r.tc)().userFileNames.m2i,{m2i:k}=(0,r.tc)().user,[I,R]=(0,o.useState)(k),{annParams:S,annStatus:N}=(0,r.tc)(),_=null!=N?N:null,V=(0,o.useMemo)(()=>"waiting"===_?"Waiting CMM & TP...":"running"===_?"Running CMM & TP...":"finished"===_||"ok"===_?"CMM & TP Finished":"error"===_?"Putative Annotation Error":"Waiting CMM & TP...",[_]),z=(0,o.useMemo)(()=>"idle"===M.status?"Idle":"waiting"===M.status?"Waiting...":"running"===M.status?"Running CMM...":"ok"===M.status?"CMM Finished":"error"===M.status?"CMM Error":"",[M.status]),A=(0,o.useMemo)(()=>"idle"===P.status?"Idle":"waiting"===P.status?"Waiting...":"running"===P.status?"Running TurboPutative...":"ok"===P.status?"TurboPutative Finished":"error"===P.status?"TurboPutative Error":"",[P.status]),O=(0,o.useMemo)(()=>{let e=I.column(S.mzCol.id),t=I.column(S.ionCol.id),s={pos:[],neg:[]};null!==S.ionValPos&&w.map((n,o)=>{I.index.includes(n)&&t.values[I.index.indexOf(n)]==S.ionValPos.id&&s.pos.push(parseFloat(e.values[I.index.indexOf(n)]))}),null!==S.ionValNeg&&w.map((n,o)=>{I.index.includes(n)&&t.values[I.index.indexOf(n)]==S.ionValNeg.id&&s.neg.push(parseFloat(e.values[I.index.indexOf(n)]))});let n={pos:[],neg:[]};for(let e=0;e<s.pos.length;e+=3)n.pos.push(s.pos.slice(e,e+3));for(let e=0;e<s.neg.length;e+=3)n.neg.push(s.neg.slice(e,e+3));return n},[S,I,w]),E=(0,o.useCallback)(async()=>{let e=[];null!==S.ionValPos&&e.push("pos"),null!==S.ionValNeg&&e.push("neg");let t=await fetch("".concat(s,"/get_turboputative/").concat(b,"/").concat(e.join("_"))),n=await t.json();"ok"==n.status?(clearInterval(f.current),j({type:"user-upload",dfJson:n.m2i,fileType:"m2i",userFileName:T,idCol:C}),j({type:"set-ann-status",status:"ok"}),Z({type:"finish-tp-mode",mode:"pos"}),Z({type:"finish-tp-mode",mode:"neg"}),Z({type:"finish-tp"})):"error"==n.status&&(j({type:"set-ann-status",status:"error"}),Z({type:"update-tp-progress",status:"error"}),clearInterval(f.current),console.log(n))},[S,b,s,T,f,j,Z,C]),W=(0,o.useCallback)((e,t,s,n)=>new Promise(async(n,o)=>{let r={metabolites_type:"all-except-peptides",databases:["all-except-mine"],masses_mode:"mz",ion_mode:e,adducts:t,tolerance:S.mzError,tolerance_mode:"ppm",masses:s};try{let e=await fetch("".concat(g),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(e.ok){let t=await e.json();n(t.results)}else console.error("Error on POST request:",e.statusText),n([])}catch(e){console.error("Error al realizar la solicitud POST:",e),n([])}}),[S,g]),F=(0,o.useCallback)(async()=>{console.log("Starting request to CMM");let e={pos:[],neg:[]};if(null!==S.ionValPos){try{for(let t=0;t<O.pos.length;t++){let s=await W("positive",S.posAdd,O.pos[t],t);e.pos=[...e.pos,...s],Z({type:"update-cmm-progress",mode:"pos",done:t+1,status:"running"}),await new Promise(e=>setTimeout(e,6e3))}}catch(e){console.error("CMM failed. Stopping process.",e),j({type:"set-ann-status",status:"error"}),Z({type:"set-cmm-error",mode:"pos",msg:"CMM failed in the Positive Mode"}),clearInterval(f.current)}finally{Z({type:"finish-cmm-mode",mode:"pos"})}try{Z({type:"update-tp-progress",mode:"pos",status:"running"}),fetch("".concat(s,"/run_turboputative/pos/").concat(b),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.pos)})}catch(e){console.error("CMM failed. Stopping process.",e),j({type:"set-ann-status",status:"error"}),Z({type:"set-cmm-error",mode:"pos",msg:"TP failed in the Positive Mode"}),clearInterval(f.current)}}if(null!==S.ionValNeg){try{for(let t=0;t<O.neg.length;t++){let s=await W("negative",S.negAdd,O.neg[t],t);e.neg=[...e.neg,...s],Z({type:"update-cmm-progress",mode:"neg",done:t+1,status:"running"}),await new Promise(e=>setTimeout(e,6e3))}}catch(e){console.error("CMM failed. Stopping process.",e),j({type:"set-ann-status",status:"error"}),Z({type:"set-cmm-error",mode:"neg",msg:"CMM failed in the Negative Mode"}),clearInterval(f.current)}finally{Z({type:"finish-cmm-mode",mode:"neg"})}try{Z({type:"update-tp-progress",mode:"neg",status:"running"}),fetch("".concat(s,"/run_turboputative/neg/").concat(b),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.neg)})}catch(e){console.error("CMM failed. Stopping process.",e),j({type:"set-ann-status",status:"error"}),Z({type:"set-tp-error",mode:"neg",msg:"TP failed in the Negative Mode"}),clearInterval(f.current)}}try{f.current||(f.current=setInterval(E,2e4))}catch(e){console.error("CMM failed. Stopping process.",e),j({type:"set-ann-status",status:"error"}),Z({type:"update-tp-progress",status:"error"}),clearInterval(f.current)}finally{j({type:"set-ann-status",status:"ok"})}},[S,O,f,E,s,W,b,j,Z]);return((0,o.useEffect)(()=>{S&&"idle"===_&&(y.current||(y.current=!0,console.log("CMMTP triggered from Annotate button"),j({type:"set-ann-status",status:"waiting"}),Z({type:"set-cmm-totals",pos:{total:O.pos.length,done:0,finished:!1},neg:{total:O.neg.length,done:0,finished:!1}}),Z({type:"init-tp-totals"}),F()))},[S,_,O,F,j,Z]),(0,o.useEffect)(()=>()=>clearInterval(f.current),[]),S&&null!==_)?(0,n.jsx)(l.Z,{sx:{display:"flex",alignItems:"center",justifyContent:"center",px:2},children:(0,n.jsx)(c.Z,{elevation:3,sx:{mt:3,p:2.5,maxWidth:700,width:"100%",borderRadius:3},children:(0,n.jsxs)(d.Z,{spacing:2,children:["error"===_&&(0,n.jsx)(h.Z,{severity:"error",children:V}),(0,n.jsxs)(m.ZP,{container:!0,spacing:2,children:[(0,n.jsxs)(m.ZP,{item:!0,xs:4,textAlign:"center",children:[(0,n.jsx)(u.Z,{variant:"subtitle1",fontWeight:600,children:"CMM"}),(0,n.jsx)(u.Z,{variant:"body2",color:"text.secondary",children:z})]}),(0,n.jsxs)(m.ZP,{item:!0,xs:4,textAlign:"center",children:[(0,n.jsx)(u.Z,{variant:"subtitle1",fontWeight:600,children:"TurboPutative"}),(0,n.jsx)(u.Z,{variant:"body2",color:"text.secondary",children:A})]}),(0,n.jsx)(m.ZP,{item:!0,xs:4,textAlign:"center",children:(0,n.jsx)(u.Z,{variant:"subtitle1",fontWeight:600,children:"Results"})})]}),(0,n.jsx)(x.Z,{}),(0,n.jsxs)(d.Z,{spacing:1,children:[S.ionValPos&&(0,n.jsxs)(m.ZP,{container:!0,spacing:2,alignItems:"center",children:[(0,n.jsx)(m.ZP,{item:!0,xs:4,children:(0,n.jsx)(ModeRow,{label:"Positive Mode",done:M.pos.done,total:M.pos.total,finished:M.pos.finished})}),(0,n.jsx)(m.ZP,{item:!0,xs:4,children:(0,n.jsx)(TPRow,{status:P.pos.status})}),(0,n.jsx)(m.ZP,{item:!0,xs:4,textAlign:"center",children:"ok"===P.pos.status?(0,n.jsx)(p.Z,{target:"_blank",underline:"hover",href:"".concat(t,"/webserver/").concat(b,"_pos"),children:"View POS Results"}):(0,n.jsx)(u.Z,{variant:"caption",color:"text.secondary",children:"—"})})]}),S.ionValNeg&&(0,n.jsxs)(m.ZP,{container:!0,spacing:2,alignItems:"center",children:[(0,n.jsx)(m.ZP,{item:!0,xs:4,children:(0,n.jsx)(ModeRow,{label:"Negative Mode",done:M.neg.done,total:M.neg.total,finished:M.neg.finished})}),(0,n.jsx)(m.ZP,{item:!0,xs:4,children:(0,n.jsx)(TPRow,{status:P.neg.status})}),(0,n.jsx)(m.ZP,{item:!0,xs:4,textAlign:"center",children:"ok"===P.neg.status?(0,n.jsx)(p.Z,{target:"_blank",underline:"hover",href:"".concat(t,"/webserver/").concat(b,"_neg"),children:"View NEG Results"}):(0,n.jsx)(u.Z,{variant:"caption",color:"text.secondary",children:"—"})})]})]}),(0,n.jsx)(x.Z,{})]})})}):(0,n.jsx)(l.Z,{sx:{minHeight:"60vh",display:"flex",alignItems:"center",justifyContent:"center",px:2},children:(0,n.jsxs)(c.Z,{elevation:2,sx:{p:3,maxWidth:420,textAlign:"center"},children:[(0,n.jsx)(u.Z,{variant:"h6",gutterBottom:!0,children:"Putative Annotation Not Available"}),(0,n.jsxs)(u.Z,{variant:"body2",color:"text.secondary",children:["You haven't added Putative Annotation parameters yet.","Go back to the annotation step and configure the settings to start CMM & TurboPutative."]})]})})}}}]);